<!DOCTYPE html>
<html>
  <head>
    <title>YouTube Stream Viewer</title>
    <style>
      body {
        margin: 20px;
        display: grid;
        place-items: center;
        font-family: system-ui;
      }
      .container {
        width: 1280px;
        background: #f5f5f5;
        border-radius: 8px;
      }
      .video-container {
        width: 100%;
        aspect-ratio: 16/9;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      .controls {
        display: flex;
        gap: 20px;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      #status {
        flex: 1;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="player" class="video-container"></div>
      <div class="controls">
        <button onclick="startStream()">Start Stream</button>
        <button onclick="stopStream()">Stop Stream</button>
        <div id="status"></div>
      </div>
    </div>
    <script>
      const playerDiv = document.getElementById('player')
      const statusDiv = document.getElementById('status')

      async function checkStreamStatus() {
        try {
          const response = await fetch('/camera/status', { credentials: 'include' })
          const status = await response.json()
          return status.stream.mode === 'youtube' && status.stream.is_active
        } catch {
          return false
        }
      }

      async function getStreamUrl() {
        const response = await fetch('/stream/youtube', { credentials: 'include' })
        const data = await response.json()
        return data.url
      }

      function createPlayer(url) {
        const videoId = new URL(url).searchParams.get('v')
        playerDiv.innerHTML = `
                        <iframe src="https://www.youtube.com/embed/{{ broadcast_key }}?autoplay=1"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>`
      }

      async function startStream() {
        if (await checkStreamStatus()) {
          statusDiv.innerHTML = 'Stream is already active'
          return
        }
        statusDiv.innerHTML = 'Please start YouTube stream from camera controls'
      }

      async function stopStream() {
        if (!(await checkStreamStatus())) {
          statusDiv.innerHTML = 'No active stream to stop'
          return
        }
        try {
          await fetch('/stream/youtube/stop', { method: 'POST', credentials: 'include' })
          playerDiv.innerHTML = ''
          statusDiv.innerHTML = 'Stream stopped'
        } catch {
          statusDiv.innerHTML = 'Failed to stop stream'
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        if (await checkStreamStatus()) {
          const url = await getStreamUrl()
          createPlayer(url)
          statusDiv.innerHTML = 'Stream active'
        } else {
          statusDiv.innerHTML = 'No active stream'
        }
      })
    </script>
  </body>
</html>
